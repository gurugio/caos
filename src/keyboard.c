
//
// SHIFT, ALT, CAPS-LOCK functions are implemented - 2008.12.25
//
//


#include <keyboard.h>
#include <printf.h>
#include <pic8259.h>
#include <irq_handler.h>
#include <io.h>
#include <irq_vector.h>


#define DEBUG
#undef DEBUG



#define TABLE_NORMAL 0
#define TABLE_CAPSLOCK 1
#define TABLE_SHIFT 2
#define TABLE_CAPS_N_SHIFT 3
#define TABLE_CTRL 4

static unsigned char scan_to_ascii[5][128] = {
	{ /* ascii table */
	0x00, 0x1b,  '1',  '2',  '3',  '4',  '5',  '6',  '7',  '8',  '9',  '0',  '-',  '=', 0x08, 0x09,
	 'q',  'w',  'e',  'r',  't',  'y',  'u',  'i',  'o',  'p',  '[',  ']', 0x0d, 0x00,  'a',  's',
	 'd',  'f',  'g',  'h',  'j',  'k',  'l',  ';', 0x27,  '`', 0x00, 0x5c,  'z',  'x',  'c',  'v',
	 'b',  'n',  'm',  ',',  '.',  '/', 0x00,  '*', 0x00,  ' ', 0x00, 0x03, 0x03, 0x03, 0x03, 0x08,
	0x03, 0x03, 0x03, 0x03, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00,  '-', 0x00, 0x00, 0x00,  '+', 0x00,
	0x00, 0x00, 0x00, 0x7f, 0x00, 0x00, 0x5c, 0x03, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x0d, 0x00,  '/', 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x7f,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  '/', 0x00, 0x00, 0x00, 0x00, 0x00,
	},
	{ /* ascii table with capslock */
	0x00, 0x1b,  '1',  '2',  '3',  '4',  '5',  '6',  '7',  '8',  '9',  '0',  '-',  '=', 0x08, 0x09,
	 'Q',  'W',  'E',  'R',  'T',  'Y',  'U',  'I',  'O',  'P',  '[',  ']', 0x0d, 0x00,  'A',  'S',
	 'D',  'F',  'G',  'H',  'J',  'K',  'L',  ';', 0x27,  '`', 0x00, 0x5c,  'Z',  'X',  'C',  'V',
	 'B',  'N',  'M',  ',',  '.',  '/', 0x00,  '*', 0x00,  ' ', 0x00, 0x03, 0x03, 0x03, 0x03, 0x08,
	0x03, 0x03, 0x03, 0x03, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00,  '-', 0x00, 0x00, 0x00,  '+', 0x00,
	0x00, 0x00, 0x00, 0x7f, 0x00, 0x00, 0x5c, 0x03, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x0d, 0x00,  '/', 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x7f,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  '/', 0x00, 0x00, 0x00, 0x00, 0x00,
	},
	{ /* ascii with shift */
	0x00, 0x1b,  '!',  '@',  '#',  '$',  '%',  '^',  '&',  '*',  '(',  ')',  '_',  '+', 0x7e, 0x7e,
	 'Q',  'W',  'E',  'R',  'T',  'Y',  'U',  'I',  'O',  'P',  '{',  '}', 0x7e, 0x00,  'A',  'S',
	 'D',  'F',  'G',  'H',  'J',  'K',  'L',  ':', 0x27,  '~', 0x00,  '|',  'Z',  'X',  'C',  'V',
	 'B',  'N',  'M',  '<',  '>',  '?', 0x00,  '*', 0x00, 0x01, 0x00, 0x01, 0x01, 0x01, 0x01, 0x01,
	0x01, 0x01, 0x01, 0x01, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00,  '-', 0x00, 0x00, 0x00,  '+', 0x00,
	0x00, 0x00, 0x01, 0x7f, 0x00, 0x00, 0x00, 0x01, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x0d, 0x00,  '/', 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x7f,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  '/', 0x00, 0x00, 0x00, 0x00, 0x00,
	},
	{ /* ascii with capslock & shift */
	0x00, 0x1b,  '!',  '@',  '#',  '$',  '%',  '^',  '&',  '*',  '(',  ')',  '_',  '+', 0x7e, 0x7e,
	 'q',  'w',  'e',  'r',  't',  'y',  'u',  'i',  'o',  'p',  '{',  '}', 0x7e, 0x00,  'a',  's',
	 'd',  'f',  'g',  'h',  'j',  'k',  'l',  ':', 0x27,  '~', 0x00,  '|',  'z',  'x',  'c',  'v',
	 'b',  'n',  'm',  '<',  '>',  '?', 0x00,  '*', 0x00, 0x01, 0x00, 0x01, 0x01, 0x01, 0x01, 0x01,	
 	0x01, 0x01, 0x01, 0x01, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00,  '-', 0x00, 0x00, 0x00,  '+', 0x00,
	0x00, 0x00, 0x01, 0x7f, 0x00, 0x00, 0x00, 0x01, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x0d, 0x00,  '/', 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x7f,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  '/', 0x00, 0x00, 0x00, 0x00, 0x00,
	},
	{ /* ascii with control */
	0x00, 0x00, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x02, 0x00, 0x00, 0x7f, 0x7f,
	0x11, 0x17, 0x05, 0x12, 0x14, 0x19, 0x15, 0x09, 0x0f, 0x10, 0x02, 0x02, 0x0a, 0x00, 0x01, 0x13,
	0x04, 0x06, 0x07, 0x08, 0x0a, 0x0b, 0x0c, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1a, 0x18, 0x03, 0x16,
	0x02, 0x0e, 0x0d, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x02, 0x02, 0x02, 0x02, 0x02,
	0x02, 0x02, 0x02, 0x02, 0x02, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x00, 0x02, 0x02, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	}
};


struct key_tag_t key;



ssize_t keyboard_init(void)
{

	caos_printf("Initialize keyboard..");

	// activate keyboard's IRQ
	if (register_irq(KEYBOARD_IRQ, keyboard_isr) == CAOS_SUCCESS) {
        caos_printf("OK\n");
    } else {
        caos_printf("ERROR\n");
        return -1;
    }

    return CAOS_SUCCESS;
}



//
//
// @num: IRQ index
//
void keyboard_isr(size_t num)
{
	unsigned char scan=0;
	static ssize_t prefix=0;
	ssize_t tmp;
	ssize_t change_flag = 0;

    num = num; /* remove compiler warning */
    
	scan = inb(0x60);


#ifdef DEBUG
	caos_printf("KEYBOARD [%x]\n", scan);
#endif

	// keyboard error
	if ( (scan == 0) || (scan == 0xff) )
		return;

	if (scan == 0xe0 || scan == 0xe1) {
		prefix = 1;
		return;
	}

	if (scan == SCAN_NUMLOCK) {
#ifdef DEBUG
		caos_printf("numlock pressed\n");
#endif
		tmp = MK_NUMLOCK;
		key.status ^= tmp;
		change_flag = 1;
	} else if (scan == SCAN_CAPSLOCK) {
#ifdef DEBUG
		caos_printf("capslock pressed\n");
#endif
		tmp = MK_CAPSLOCK;
		key.status ^= tmp;
		change_flag = 1;
	} else if (scan == SCAN_SCROLLLOCK) {
#ifdef DEBUG
		caos_printf("scroll-lock pressed\n");
#endif
		tmp = MK_SCROLLLOCK;
		key.status ^= tmp;
		change_flag = 1;
	} else if (scan == SCAN_LEFTSHIFT) {
#ifdef DEBUG
		caos_printf("left_shift pressed\n");
#endif
		tmp = MK_SHIFT;
		key.status |= tmp;
		change_flag = 1;
	} else if (scan == (SCAN_LEFTSHIFT|0x80)) {
#ifdef DEBUG
		caos_printf("left-shift released\n");
#endif
		tmp = MK_SHIFT;
		key.status &= ~tmp;
		change_flag = 1;
#ifdef DEBUG
	/*} else if (scan == SCAN_RIGHTSHIFT) {
		//caos_printf("right-shift pressed\n");
		tmp = MK_SHIFT;
		key.status |= tmp;
		change_flag = 1;
	} else if (scan == (SCAN_RIGHTSHIFT|0x80)) {
		//caos_printf("right-shift released\n");
		tmp = MK_SHIFT;
		key.status &= ~tmp;
		change_flag = 1;*/
#endif
	} else if (scan == SCAN_LEFTCTRL) {
#ifdef DEBUG
		caos_printf("left-ctrl pressed\n");
#endif
		tmp = MK_CTRL;
		key.status |= tmp;
		change_flag = 1;
	} else if (scan == (SCAN_LEFTCTRL|0x80)) {
#ifdef DEBUG
		caos_printf("left-ctrl released\n");
#endif
		tmp = MK_CTRL;
		key.status &= ~tmp;
		change_flag = 1;
	} else if (scan == SCAN_LEFTALT) {
#ifdef DEBUG
		caos_printf("alt pressed\n");
#endif
		tmp = MK_ALT;
		key.status |= tmp;
		change_flag = 1;
	} else if (scan == (SCAN_LEFTALT|0x80)) {
#ifdef DEBUG
		caos_printf("alt released\n");
#endif
		tmp = MK_ALT;
		key.status &= ~tmp;
		change_flag = 1;
	}

	if (change_flag != 0) {
		// change keyboard LED
		//
		return;
	}

	//
	// Don't process key-releasing
	if (scan & 0x80)
		return;


	/*
	 * if no status, scan_to_ascii[0][scan]
	 * if capslock, scan_to_ascii[1][scan]
	 * ... ...
	 */
	if ( (key.status & MK_CAPSLOCK) && (key.status & MK_SHIFT) )
		key.code = scan_to_ascii[TABLE_CAPS_N_SHIFT][scan];
	else if (key.status == 0) 
		key.code = scan_to_ascii[TABLE_NORMAL][scan];
	else if (key.status & MK_CAPSLOCK) 
		key.code = scan_to_ascii[TABLE_CAPSLOCK][scan];
	else if (key.status & MK_SHIFT) 
		key.code = scan_to_ascii[TABLE_SHIFT][scan];
	else if (key.status & MK_CTRL) 
		key.code = scan_to_ascii[TABLE_CTRL][scan];
	else
		key.code = 0xff;	// 0xff is error code


	if (scan == SCAN_ENTER) {
		caos_printf("\n");
		return;
	} else if (scan == SCAN_BACKSPACE) {
		caos_delchar(1);
		return;
	}


	caos_printf("%c", key.code);


	prefix = 0;


}














